<!-- saved from url=(0014)about:internet -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Hyperbolic2DLayouter.as</title>
<link rel="stylesheet" type="text/css" href="../../../../../../../../SourceStyles.css"/>
</head>

<body><pre><span class="ActionScriptComment">/* 
 * The MIT License
 *
 * Copyright (c) 2007 The SixDegrees Project Team
 * (Jason Bellone, Juan Rodriguez, Segolene de Basquiat, Daniel Lang).
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the &quot;Software&quot;), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */</span>
<span class="ActionScriptpackage">package</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">graphLayout</span>.<span class="ActionScriptDefault_Text">layout</span> <span class="ActionScriptBracket/Brace">{</span>
    
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">display</span>.<span class="ActionScriptDefault_Text">DisplayObject</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">events</span>.<span class="ActionScriptDefault_Text">TimerEvent</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">Dictionary</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">events</span>.<span class="ActionScriptDefault_Text">MouseEvent</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">geom</span>.<span class="ActionScriptDefault_Text">Point</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">flash</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">Timer</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">mx</span>.<span class="ActionScriptDefault_Text">core</span>.<span class="ActionScriptDefault_Text">UIComponent</span>;
        
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">graphLayout</span>.<span class="ActionScriptDefault_Text">data</span>.<span class="ActionScriptDefault_Text">INode</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">graphLayout</span>.<span class="ActionScriptDefault_Text">visual</span>.<span class="ActionScriptDefault_Text">VisualNode</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">graphLayout</span>.<span class="ActionScriptDefault_Text">visual</span>.<span class="ActionScriptDefault_Text">IVisualGraph</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">graphLayout</span>.<span class="ActionScriptDefault_Text">visual</span>.<span class="ActionScriptDefault_Text">IVisualNode</span>;
    
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">geom</span>.<span class="ActionScriptDefault_Text">ComplexNumber</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">geom</span>.<span class="ActionScriptDefault_Text">ComplexVector</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">geom</span>.<span class="ActionScriptDefault_Text">IPoint</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">geom</span>.<span class="ActionScriptDefault_Text">IVector</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">geom</span>.<span class="ActionScriptDefault_Text">IIsometry</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">geom</span>.<span class="ActionScriptDefault_Text">IProjector</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">geom</span>.<span class="ActionScriptDefault_Text">PoincareIsometry</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">geom</span>.<span class="ActionScriptDefault_Text">PoincareModel</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">geom</span>.<span class="ActionScriptDefault_Text">PoincareProjector</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">LogUtil</span>;
    <span class="ActionScriptReserved">import</span> <span class="ActionScriptDefault_Text">org</span>.<span class="ActionScriptDefault_Text">un</span>.<span class="ActionScriptDefault_Text">cava</span>.<span class="ActionScriptDefault_Text">birdeye</span>.<span class="ActionScriptDefault_Text">ravis</span>.<span class="ActionScriptDefault_Text">utils</span>.<span class="ActionScriptDefault_Text">GraphicUtils</span>;

    <span class="ActionScriptASDoc">/**
     * This is an implementation of the Hyperbolic 2D layouting algorithm.&lt;br&gt;
     * For this iterative layout, most of default mouse behavior, namely:&lt;br&gt;
     * (1) scrolling while background drag, and &lt;br&gt;
     * (2) node drag-drop&lt;br&gt;
     * should be turned-off in &lt;code&gt;VisualGraph&lt;/code&gt;. 
     * &lt;hr&gt;
     * The implementation is a rewrite of Jens Kanschik&apos;s Hypergraph
     * implementation in Java. However, apart from the general idea 
     * and some variable names, this code improves on hypergraph 
     * and also implements additional functionality.
     * 
     * Copyright (C) 2003  Jens Kanschik,
     * mail : jensKanschik@users.sourceforge.net
     * 
     * Copyright of this reimplementation in Flex:
     * (c) Nitin Lamba, 2007.
     * 
     * @author Nitin Lamba
     * 
     * XXX TODO: Needs to honor the &apos;_disableAnimation&apos; protected variable
     * if possible XXX
     */</span>

    <span class="ActionScriptReserved">public</span> <span class="ActionScriptclass">class</span> <span class="ActionScriptDefault_Text">Hyperbolic2DLayouter</span> <span class="ActionScriptReserved">extends</span> <span class="ActionScriptDefault_Text">IterativeBaseLayouter</span> <span class="ActionScriptReserved">implements</span> <span class="ActionScriptDefault_Text">ILayoutAlgorithm</span> <span class="ActionScriptBracket/Brace">{</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">_LOG</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">String</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptString">&quot;graphLayout.layout.Hyperbolic2DLayouter&quot;</span>;
        
      <span class="ActionScriptReserved">public</span> <span class="ActionScriptReserved">static</span> <span class="ActionScriptReserved">const</span> <span class="ActionScriptDefault_Text">ANIMATION_STEPS</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span> <span class="ActionScriptOperator">=</span> 10;
        
     <span class="ActionScriptASDoc">/*********************************************
        * INTERNAL OBJECTS
        *********************************************/</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_model</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">PoincareModel</span>;
        <span class="ActionScriptReserved">private</span>    <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_projector</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">PoincareProjector</span>;
        
     <span class="ActionScriptASDoc">/*********************************************
        * LOCAL VARIABLES
        *********************************************/</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>; <span class="ActionScriptComment">// of VisualNode objects
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_nodePositions</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>; <span class="ActionScriptComment">// of ComplexNumber objects
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_tempPositions</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>; <span class="ActionScriptComment">// of ComplexNumber objects
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_gradient</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>; <span class="ActionScriptComment">// of ComplexVector objects
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_previousGradient</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>; <span class="ActionScriptComment">// of ComplexVector objects
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_distances</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>; <span class="ActionScriptComment">// 2D array of Number
</span>        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_stepWidth</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 1;
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_gradientNorm2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_previousGradientNorm2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_energy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_lastEnergy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_dragStartX</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_dragStartY</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span>;
        
        <span class="ActionScriptComment">// TEMPORARY VARIABLES - to speed-up computations
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">t_v1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ComplexVector</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ComplexVector</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">t_v2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ComplexVector</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ComplexVector</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">t_isom1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IIsometry</span>;
        
        <span class="ActionScriptComment">// ANIMATION VARIABLES
</span>        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_animationIsometries</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>;
        
        <span class="ActionScriptASDoc">/**
         * @internal
         * timer object for the animation */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_animTimer</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Timer</span>;
        
        <span class="ActionScriptASDoc">/**
         * Indicator if there is currently an animation in progress
         * */</span>
        <span class="ActionScriptReserved">protected</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_animInProgress</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
        
        <span class="ActionScriptASDoc">/**
         * @internal
         * the current step in the animation cycle */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_animStep</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>; 
        
     <span class="ActionScriptASDoc">/*********************************************
        * PARAMETERS
        *********************************************/</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_connectedDisparity</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_repulsingForce</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span>;
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">_repulsingForceCutOff</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span>;
        
        <span class="ActionScriptASDoc">/*********************************************
        * Initialization - Constructors, resets
        * ********************************************/</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">Hyperbolic2DLayouter</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">vg</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IVisualGraph</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">super</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">vg</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">resetAll</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptDefault_Text">_model</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">PoincareModel</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">_projector</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">PoincareProjector</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_model</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">t_isom1</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_model</span>.<span class="ActionScriptDefault_Text">getIdentity</span><span class="ActionScriptBracket/Brace">()</span>;
            
            <span class="ActionScriptComment">// setup all parameter values
</span>            <span class="ActionScriptDefault_Text">_connectedDisparity</span> <span class="ActionScriptOperator">=</span> 0.2; <span class="ActionScriptComment">//0.2
</span>            <span class="ActionScriptDefault_Text">_repulsingForce</span> <span class="ActionScriptOperator">=</span> 0.05; <span class="ActionScriptComment">//0.05
</span>            <span class="ActionScriptDefault_Text">_repulsingForceCutOff</span> <span class="ActionScriptOperator">=</span> 5; <span class="ActionScriptComment">//5
</span>            
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * @inheritDoc
         * */</span>
        <span class="ActionScriptReserved">override</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">resetAll</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">super</span>.<span class="ActionScriptDefault_Text">resetAll</span><span class="ActionScriptBracket/Brace">()</span>; <span class="ActionScriptComment">// calls refreshInit()
</span>            
            <span class="ActionScriptComment">// reset all data caches
</span>            <span class="ActionScriptDefault_Text">_nodeIndex</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;
            <span class="ActionScriptDefault_Text">_nodePositions</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;
            <span class="ActionScriptDefault_Text">_tempPositions</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;

            <span class="ActionScriptDefault_Text">_distances</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;
            <span class="ActionScriptDefault_Text">_gradient</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;
            <span class="ActionScriptDefault_Text">_previousGradient</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * @inheritDoc
         * */</span>
        <span class="ActionScriptReserved">override</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">refreshInit</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// reset all local variables
</span>            <span class="ActionScriptDefault_Text">_gradientNorm2</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">_previousGradientNorm2</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">_energy</span> <span class="ActionScriptOperator">=</span> 1; <span class="ActionScriptComment">// random value to prevent division by zero in isStable()
</span>            <span class="ActionScriptDefault_Text">_lastEnergy</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptDefault_Text">_stepWidth</span> <span class="ActionScriptOperator">=</span> 0.05;
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptASDoc">/*********************************************
        * Layout Methods - Computations
        * ********************************************/</span>
        
        <span class="ActionScriptComment">/* Terminating condition for the layout */</span>
        <span class="ActionScriptReserved">override</span> <span class="ActionScriptReserved">protected</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">isStable</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_stepWidth</span> <span class="ActionScriptOperator">&lt;</span> 0.00001<span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptOperator">||</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_energy</span> <span class="ActionScriptOperator">&lt;</span> 0.01<span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptOperator">||</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Math</span>.<span class="ActionScriptDefault_Text">abs</span><span class="ActionScriptBracket/Brace">((</span><span class="ActionScriptDefault_Text">_energy</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">_lastEnergy</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">_energy</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&lt;</span> 0.0001 <span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">/* Calculation step of the layout */</span>
        <span class="ActionScriptReserved">override</span> <span class="ActionScriptReserved">protected</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">calculateLayout</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">allVisVNodes</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Dictionary</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_vgraph</span>.<span class="ActionScriptDefault_Text">visibleVNodes</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">vn</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IVisualNode</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">totalNodes</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_vgraph</span>.<span class="ActionScriptDefault_Text">noVisibleVNodes</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            
            <span class="ActionScriptComment">// 1: Initialize global variables to avoid garbage collection.
</span>            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">//LogUtil.debug(_LOG, &quot;Resetting node indexes...&quot;);
</span>                <span class="ActionScriptDefault_Text">_nodeIndex</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">totalNodes</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">=</span> 0;
                  <span class="ActionScriptReserved">for</span> <span class="ActionScriptReserved">each</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">vn</span> <span class="ActionScriptReserved">in</span> <span class="ActionScriptDefault_Text">allVisVNodes</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">vn</span>;
                    <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">k</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodePositions</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptComment">// UnProject Euclidean Space to Poincare Model
</span>                <span class="ActionScriptComment">//LogUtil.debug(_LOG, &quot;Resetting node positions...&quot;);
</span>                <span class="ActionScriptDefault_Text">_nodePositions</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">totalNodes</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//ComplexNumber
</span>                <span class="ActionScriptDefault_Text">unProjectNodes</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_gradient</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">//LogUtil.debug(_LOG, &quot;Resetting gradients...&quot;);
</span>                <span class="ActionScriptDefault_Text">_gradient</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">totalNodes</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">//ComplexVector
</span>                <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">totalNodes</span>; <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">_gradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ComplexVector</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodePositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexNumber</span>, <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">())</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_tempPositions</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">//LogUtil.debug(_LOG, &quot;Resetting temp node positions...&quot;);
</span>                <span class="ActionScriptDefault_Text">_tempPositions</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">totalNodes</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// ComplexNumber
</span>                <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">totalNodes</span>; <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">_tempPositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_distances</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">//LogUtil.debug(_LOG, &quot;Resetting distance matrix...&quot;);
</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
                <span class="ActionScriptDefault_Text">_distances</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">totalNodes</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">totalNodes</span>; <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">_distances</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">totalNodes</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">j</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">j</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">totalNodes</span>; <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptDefault_Text">_distances</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">][</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> 0.0;
                    <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptComment">// 2: Perform the calculations for this iteration
</span>            <span class="ActionScriptComment">// 2.1: Initialize global variables to avoid garbage collection.
</span>            <span class="ActionScriptDefault_Text">_previousGradientNorm2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_gradientNorm2</span>;
            <span class="ActionScriptDefault_Text">_lastEnergy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_energy</span>;

            <span class="ActionScriptComment">// 2.2: Computation of distances, gradients
</span>            <span class="ActionScriptDefault_Text">computeDistances</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodePositions</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">_gradientNorm2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">computeGradient</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodePositions</span>, <span class="ActionScriptDefault_Text">_gradient</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_previousGradient</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">_previousGradient</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">totalNodes</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// ComplexVector
</span>                <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">totalNodes</span>; <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">_previousGradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_gradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexVector</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">clone</span><span class="ActionScriptBracket/Brace">()</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexVector</span>;
                <span class="ActionScriptDefault_Text">_previousGradientNorm2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_gradientNorm2</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptComment">// compare gradient with previous gradient to spot oscillation
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">gradientProduct</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">_gradient</span>.<span class="ActionScriptDefault_Text">length</span>; <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">gradientProduct</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">_model</span>.<span class="ActionScriptDefault_Text">product</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_gradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVector</span>, <span class="ActionScriptDefault_Text">_previousGradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVector</span><span class="ActionScriptBracket/Brace">)</span>;
                
            <span class="ActionScriptComment">// 2.3: Adjust step width
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">angle</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">gradientProduct</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptDefault_Text">Math</span>.<span class="ActionScriptDefault_Text">sqrt</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_gradientNorm2</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">_previousGradientNorm2</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">angle</span> <span class="ActionScriptOperator">&gt;</span> 0.9<span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">_stepWidth</span> <span class="ActionScriptOperator">*=</span> 1.1;
            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">angle</span> <span class="ActionScriptOperator">&gt;</span> 0.8<span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">_stepWidth</span> <span class="ActionScriptOperator">*=</span> 1.05;
            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">angle</span> <span class="ActionScriptOperator">&gt;</span> 0.5<span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">_stepWidth</span> <span class="ActionScriptOperator">*=</span> 1;
            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">angle</span> <span class="ActionScriptOperator">&gt;</span> 0.3<span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">_stepWidth</span> <span class="ActionScriptOperator">*=</span> 0.7;
            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">angle</span> <span class="ActionScriptOperator">&gt;</span> 0.2<span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">_stepWidth</span> <span class="ActionScriptOperator">*=</span> 0.4;
            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">angle</span> <span class="ActionScriptOperator">&gt;</span> 0.1<span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptDefault_Text">_stepWidth</span> <span class="ActionScriptOperator">*=</span> 0.2;
            <span class="ActionScriptReserved">else</span>
                <span class="ActionScriptDefault_Text">_stepWidth</span> <span class="ActionScriptOperator">*=</span> 0.1;
                
            <span class="ActionScriptComment">// 2.4: Compute new node positions
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">step</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">totalNodes</span>; <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">step</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_stepWidth</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">_model</span>.<span class="ActionScriptDefault_Text">length</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_gradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVector</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">step</span> <span class="ActionScriptOperator">&gt;</span> 0.2<span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">step</span> <span class="ActionScriptOperator">=</span> 0.2;
                <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_tempPositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">setTo</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodePositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IPoint</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">_model</span>.<span class="ActionScriptDefault_Text">getTranslationIVR</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">t_isom1</span>, <span class="ActionScriptDefault_Text">_gradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVector</span>, <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">step</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">t_isom1</span>.<span class="ActionScriptDefault_Text">applyToPoint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_tempPositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IPoint</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">t_isom1</span>.<span class="ActionScriptDefault_Text">applyToVector</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_gradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVector</span><span class="ActionScriptBracket/Brace">)</span>; 
                <span class="ActionScriptComment">/* 
                 * the gradient has to be translated along the geodesic from the old 
                 * to the new position so that we can compare it with the next gradient.
                 */</span>
                <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_previousGradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexVector</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">setTo</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_gradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVector</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodePositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">setTo</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_tempPositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IPoint</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptComment">// 2.5: Compute new energy
</span>            <span class="ActionScriptDefault_Text">_energy</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">getEnergy</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptComment">/*
            LogUtil.debug(_LOG, &quot;  Energy: &quot; + _energy 
                           + &quot;  StepWidth: &quot; + _stepWidth
                           + &quot;  Gradient Norm: &quot; + _gradientNorm2
                           + &quot;  Angle: &quot;  + gradientProduct/Math.sqrt(_gradientNorm2*_previousGradientNorm2));
            */</span>
            
            <span class="ActionScriptComment">// 3: Map from Poincare Model to Euclidean Space
</span>            <span class="ActionScriptDefault_Text">projectNodes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
  <span class="ActionScriptASDoc">/************************************************
     * Helper Functions - Layout Computations
     ************************************************/</span>
      <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">projectNodes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">updateNodeUI</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">newNodePos</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Point</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">newNodeScale</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Point</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            
            <span class="ActionScriptComment">/* it happens for some reasons that the _nodeIndex array 
             * was not initialised, then this crashes, adding a safeguard
             */</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">LogUtil</span>.<span class="ActionScriptDefault_Text">warn</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_LOG</span>, <span class="ActionScriptString">&quot;_nodeIndex not initialised in Hyperbolic2DLayouter.projectNodes()&quot;</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">return</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">_nodeIndex</span>.<span class="ActionScriptDefault_Text">length</span>; <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                 <span class="ActionScriptComment">// Use Projector to map Complex Points to 2D display
</span>                <span class="ActionScriptDefault_Text">newNodePos</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_projector</span>.<span class="ActionScriptDefault_Text">project</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodePositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IPoint</span>, <span class="ActionScriptDefault_Text">_vgraph</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">DisplayObject</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptComment">// DEBUG - CHECK:
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">isNaN</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">newNodePos</span>.<span class="ActionScriptDefault_Text">x</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScripttrace">trace</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;HyperbolicLayout: Projected position for &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">VisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">node</span>.<span class="ActionScriptDefault_Text">stringid</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; = &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">newNodePos</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScripttrace">trace</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptString">&quot;  Node Position in Model = &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodePositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IPoint</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">toString</span><span class="ActionScriptBracket/Brace">())</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">VisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">newNodePos</span>.<span class="ActionScriptDefault_Text">x</span>;
                <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">VisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">newNodePos</span>.<span class="ActionScriptDefault_Text">y</span>;
                
                 <span class="ActionScriptComment">// Scaling of visual components at points
</span>                <span class="ActionScriptDefault_Text">newNodeScale</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_projector</span>.<span class="ActionScriptDefault_Text">getScale</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodePositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IPoint</span><span class="ActionScriptBracket/Brace">)</span>;
                
                <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">VisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">view</span>.<span class="ActionScriptDefault_Text">scaleX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">newNodeScale</span>.<span class="ActionScriptDefault_Text">x</span>;
                <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">VisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">view</span>.<span class="ActionScriptDefault_Text">scaleY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">newNodeScale</span>.<span class="ActionScriptDefault_Text">y</span>;
                
                <span class="ActionScriptComment">// Commit the position changes if UI needs to be updated
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">updateNodeUI</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">VisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">commit</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span>
      <span class="ActionScriptBracket/Brace">}</span>
        
      <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">unProjectNodes</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">oldNodePos</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Point</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">temp</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ComplexNumber</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">_nodeIndex</span>.<span class="ActionScriptDefault_Text">length</span>; <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// UnProject all nodes from 2D display to Complex Points
</span>                <span class="ActionScriptDefault_Text">oldNodePos</span>.<span class="ActionScriptDefault_Text">x</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">x</span>;
                <span class="ActionScriptDefault_Text">oldNodePos</span>.<span class="ActionScriptDefault_Text">y</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">y</span>;
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptDefault_Text">GraphicUtils</span>.<span class="ActionScriptDefault_Text">equal</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">oldNodePos</span>, <span class="ActionScriptDefault_Text">GraphicUtils</span>.<span class="ActionScriptDefault_Text">getCenter</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_vgraph</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">DisplayObject</span><span class="ActionScriptBracket/Brace">))</span> 
                  <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptBracket/Brace">((</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVisualNode</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">_vgraph</span>.<span class="ActionScriptDefault_Text">currentRootVNode</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptComment">//new point added not the root
</span>                    <span class="ActionScriptComment">// Start from Random positions for newly added nodes
</span>                    <span class="ActionScriptDefault_Text">temp</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">()</span>;
                    <span class="ActionScriptDefault_Text">translateRandomly</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">temp</span>, 1.5, 2.5<span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptDefault_Text">_nodePositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">temp</span>;
                    <span class="ActionScriptComment">/*
                    _LOG.debug( (_nodeIndex[k] as VisualNode).node.stringid 
                        + &quot;: Randomly set position to &quot; + _nodePositions[k] );
                    */</span>
                <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">_nodePositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_projector</span>.<span class="ActionScriptDefault_Text">unProject</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">oldNodePos</span>, <span class="ActionScriptDefault_Text">_vgraph</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">DisplayObject</span>, <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptComment">// DEBUG - CHECK:
</span>                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">isNaN</span><span class="ActionScriptBracket/Brace">((</span><span class="ActionScriptDefault_Text">_nodePositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">real</span><span class="ActionScriptBracket/Brace">))</span> 
                    <span class="ActionScriptDefault_Text">LogUtil</span>.<span class="ActionScriptDefault_Text">warn</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_LOG</span>, <span class="ActionScriptString">&quot;HyperbolicLayout: &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">VisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">node</span>.<span class="ActionScriptDefault_Text">stringid</span> 
                        <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;: Node position set to &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">_nodePositions</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
      <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getEnergy</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">energy</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">=</span>0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">_nodeIndex</span>.<span class="ActionScriptDefault_Text">length</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">+</span>1; <span class="ActionScriptDefault_Text">j</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">_nodeIndex</span>.<span class="ActionScriptDefault_Text">length</span>; <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptDefault_Text">energy</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">getWeight</span><span class="ActionScriptBracket/Brace">((</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">node</span>,
                                                            <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">node</span>,
                                                            <span class="ActionScriptDefault_Text">getDistance</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span>, <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">))</span>;
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">energy</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">computeDistances</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            
             <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">=</span>0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">_nodeIndex</span>.<span class="ActionScriptDefault_Text">length</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">=</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">+</span>1; <span class="ActionScriptDefault_Text">j</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">_nodeIndex</span>.<span class="ActionScriptDefault_Text">length</span>; <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                  <span class="ActionScriptDefault_Text">_distances</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">][</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_model</span>.<span class="ActionScriptDefault_Text">distP</span><span class="ActionScriptBracket/Brace">((</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IPoint</span><span class="ActionScriptBracket/Brace">)</span>, 
                                                                                    <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IPoint</span><span class="ActionScriptBracket/Brace">))</span>;
                    <span class="ActionScriptComment">//DEBUG - CHECK:
</span>                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">((</span><span class="ActionScriptDefault_Text">_distances</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">][</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptOperator">&lt;=</span> 1<span class="ActionScriptDefault_Text">e</span><span class="ActionScriptOperator">-</span>10<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">||</span> <span class="ActionScriptDefault_Text">isNaN</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_distances</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">][</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">]))</span>
                        <span class="ActionScriptDefault_Text">LogUtil</span>.<span class="ActionScriptDefault_Text">warn</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_LOG</span>, <span class="ActionScriptString">&quot;HyperbolicLayout: Distance for (&quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;, &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">j</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;) is = &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">_distances</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">][</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">])</span>;
                <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getDistance</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>, <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&gt;</span> <span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">)</span> 
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_distances</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">][</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span>;
            <span class="ActionScriptReserved">else</span>
                <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_distances</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">][</span><span class="ActionScriptDefault_Text">j</span><span class="ActionScriptBracket/Brace">]</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">computeGradient</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span>, <span class="ActionScriptDefault_Text">gradient</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">norm2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">nodeNorm2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 0;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">w</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">_nodeIndex</span>.<span class="ActionScriptDefault_Text">length</span>; <span class="ActionScriptDefault_Text">k</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">gradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexVector</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">scale</span><span class="ActionScriptBracket/Brace">(</span>0<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">=</span> 0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">_nodeIndex</span>.<span class="ActionScriptDefault_Text">length</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                    <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                        <span class="ActionScriptDefault_Text">w</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">getWeightDerivative</span><span class="ActionScriptBracket/Brace">((</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">node</span>,
                                                                        <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">node</span>,
                                                                        <span class="ActionScriptDefault_Text">getDistance</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">k</span>, <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">))</span>;
                        <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">Math</span>.<span class="ActionScriptDefault_Text">abs</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">w</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&gt;</span> 0.001<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                            <span class="ActionScriptDefault_Text">_model</span>.<span class="ActionScriptDefault_Text">distanceGradientV</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IPoint</span>,
                                                                             <span class="ActionScriptDefault_Text">position</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IPoint</span>, <span class="ActionScriptDefault_Text">t_v2</span><span class="ActionScriptBracket/Brace">)</span>;
                            
                            <span class="ActionScriptComment">//DEBUG - CHECK:
</span>                            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">isNaN</span><span class="ActionScriptBracket/Brace">((</span><span class="ActionScriptDefault_Text">t_v2</span>.<span class="ActionScriptDefault_Text">dir</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">real</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptBracket/Brace">{</span>
                                <span class="ActionScriptDefault_Text">LogUtil</span>.<span class="ActionScriptDefault_Text">warn</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_LOG</span>, <span class="ActionScriptString">&quot;Hyperbolic2DLayouter: [k = &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">k</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;] [i = &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot;] Gradient vector between nodes &quot;</span> 
                                     <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">VisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">node</span>.<span class="ActionScriptDefault_Text">stringid</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; &amp; &quot;</span>
                                     <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_nodeIndex</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">VisualNode</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">node</span>.<span class="ActionScriptDefault_Text">stringid</span> 
                                     <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; is: &quot;</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptDefault_Text">t_v2</span> <span class="ActionScriptBracket/Brace">)</span>;
                                <span class="ActionScriptDefault_Text">LogUtil</span>.<span class="ActionScriptDefault_Text">warn</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_LOG</span>, <span class="ActionScriptString">&quot;  Positions are &quot;</span> 
                                     <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IPoint</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptString">&quot; &amp; &quot;</span>
                                     <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">position</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IPoint</span><span class="ActionScriptBracket/Brace">))</span>;
                            <span class="ActionScriptBracket/Brace">}</span>
                            <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">t_v2</span>.<span class="ActionScriptDefault_Text">dir</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">multiplyF</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">w</span><span class="ActionScriptBracket/Brace">)</span>;
                            <span class="ActionScriptBracket/Brace">((</span><span class="ActionScriptDefault_Text">gradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexVector</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">dir</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">addC</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">t_v2</span>.<span class="ActionScriptDefault_Text">dir</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">)</span>;
                        <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptBracket/Brace">}</span>
                <span class="ActionScriptDefault_Text">nodeNorm2</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_model</span>.<span class="ActionScriptDefault_Text">length2</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">gradient</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">k</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">IVector</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">norm2</span> <span class="ActionScriptOperator">+=</span> <span class="ActionScriptDefault_Text">nodeNorm2</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">norm2</span>;    
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">translateRandomly</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pos</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">ComplexNumber</span>, <span class="ActionScriptDefault_Text">minR</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span>, <span class="ActionScriptDefault_Text">maxR</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">alpha</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> 2 <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">Math</span>.<span class="ActionScriptDefault_Text">PI</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">Math</span>.<span class="ActionScriptDefault_Text">random</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">t</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">minR</span> <span class="ActionScriptOperator">+</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">maxR</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">minR</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">Math</span>.<span class="ActionScriptDefault_Text">random</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">t_v1</span>.<span class="ActionScriptDefault_Text">base</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">pos</span>;
            <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">t_v1</span>.<span class="ActionScriptDefault_Text">dir</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">real</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">t</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">Math</span>.<span class="ActionScriptDefault_Text">cos</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">alpha</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">t_v1</span>.<span class="ActionScriptDefault_Text">dir</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">imag</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">t</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">Math</span>.<span class="ActionScriptDefault_Text">sin</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">alpha</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">_model</span>.<span class="ActionScriptDefault_Text">getTranslationIVR</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">t_isom1</span>, <span class="ActionScriptDefault_Text">t_v1</span>, <span class="ActionScriptDefault_Text">t</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">t_isom1</span>.<span class="ActionScriptDefault_Text">applyToPoint</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">pos</span><span class="ActionScriptBracket/Brace">)</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">/*
         * Weight Computation - 3 Cases:
         * ----------------------------
         * 
         * Case 1: Nodes are directly connected
         *    -&gt; (d - connectedDisparity)^2
         * Case 2: Nodes belong to same spanning tree
         *   if closer than _repulsingForceCutOff (= d0)
         *    -&gt; F/d - F/d0
         * Case 3: Nodes are completely disconnected (different spanning trees)
         *   if closer than _cut
         *    -&gt; F/d - F/_cut
         * 
         * As of Nov/23/2007, Case 3 conditions are never satisfied (only one spanning tree)
         * hence commented out
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getWeight</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">n1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">INode</span>, <span class="ActionScriptDefault_Text">n2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">INode</span>, <span class="ActionScriptDefault_Text">d</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">isConnected</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">n1</span>, <span class="ActionScriptDefault_Text">n2</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptComment">// Case 1: Directly connected
</span>                <span class="ActionScriptReserved">return</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">_connectedDisparity</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">_connectedDisparity</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// for classical MDS
</span>            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">_repulsingForceCutOff</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptComment">// Case 2: Belong to same spanning tree
</span>                <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_repulsingForce</span><span class="ActionScriptOperator">/</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">_repulsingForce</span><span class="ActionScriptOperator">/</span><span class="ActionScriptDefault_Text">_repulsingForceCutOff</span>;
            <span class="ActionScriptReserved">else</span>
                <span class="ActionScriptReserved">return</span> 0;
            <span class="ActionScriptComment">/*
            if (getConnectedComponent(n1).contains(n2)) {
                if (d &lt; _repulsingForceCutOff)
                    return _repulsingForce/d - _repulsingForce/_repulsingForceCutOff;
            } else if (d &lt; _cut)
                return _repulsingForce/d - _repulsingForce/_cut;
            return 0;
            */</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptComment">/*
         * Weight Derivative Computation - 3 Cases:
         * ---------------------------------------
         * 
         * Case 1: Nodes are directly connected
         *    -&gt; 2(d - connectedDisparity)
         * Case 2: Nodes belong to same spanning tree
         *   if closer than _repulsingForceCutOff (= d0)
         *    -&gt; -F/(d*d)
         * Case 3: Nodes are completely disconnected (different spanning trees)
         *   if closer than _cut
         *    -&gt; -F/(d*d)
         * 
         * As of Nov/23/2007, Case 3 conditions are never satisfied (only one spanning tree)
         * hence commented out
         */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">getWeightDerivative</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">n1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">INode</span>, <span class="ActionScriptDefault_Text">n2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">INode</span>, <span class="ActionScriptDefault_Text">d</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Number</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">isConnected</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">n1</span>, <span class="ActionScriptDefault_Text">n2</span><span class="ActionScriptBracket/Brace">))</span> <span class="ActionScriptComment">// Case 1: Directly connected
</span>                <span class="ActionScriptReserved">return</span> 2 <span class="ActionScriptOperator">*</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">-</span> <span class="ActionScriptDefault_Text">_connectedDisparity</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptReserved">else</span> <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">_repulsingForceCutOff</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptComment">// Case 2: Belong to same spanning tree
</span>                    <span class="ActionScriptReserved">return</span> <span class="ActionScriptOperator">-</span><span class="ActionScriptDefault_Text">_repulsingForce</span> <span class="ActionScriptOperator">/</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">d</span> <span class="ActionScriptOperator">*</span> <span class="ActionScriptDefault_Text">d</span><span class="ActionScriptBracket/Brace">)</span>; <span class="ActionScriptComment">// repulsing force for force directed layout.
</span>            <span class="ActionScriptReserved">else</span>
                <span class="ActionScriptReserved">return</span> 0;
            <span class="ActionScriptComment">/*
            if (getConnectedComponent(n1).contains(n2)) {
                if (d &lt; _repulsingForceCutOff)
                    return -_repulsingForce / (d * d); // repulsing force for force directed layout.
            } else if (d &lt; _cut)
                return -_repulsingForce / (d * d); // repulsing force for force directed layout.
            return 0;
            */</span>
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">isConnected</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">n1</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">INode</span>, <span class="ActionScriptDefault_Text">n2</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">INode</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">predessors</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">n1</span>.<span class="ActionScriptDefault_Text">predecessors</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">successors</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">n1</span>.<span class="ActionScriptDefault_Text">successors</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">otherNode</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">INode</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">rtn</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Boolean</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">int</span>;
            
            <span class="ActionScriptComment">// check predessors
</span>            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">=</span>0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">predessors</span>.<span class="ActionScriptDefault_Text">length</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">n2</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">predessors</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">INode</span><span class="ActionScriptBracket/Brace">))</span>
                  <span class="ActionScriptDefault_Text">rtn</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
            
            <span class="ActionScriptComment">// check successors
</span>            <span class="ActionScriptReserved">for</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">=</span>0; <span class="ActionScriptDefault_Text">i</span> <span class="ActionScriptOperator">&lt;</span> <span class="ActionScriptDefault_Text">successors</span>.<span class="ActionScriptDefault_Text">length</span>; <span class="ActionScriptDefault_Text">i</span><span class="ActionScriptOperator">++</span><span class="ActionScriptBracket/Brace">)</span>
                <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">n2</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">successors</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">i</span><span class="ActionScriptBracket/Brace">]</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">INode</span><span class="ActionScriptBracket/Brace">))</span>
                  <span class="ActionScriptDefault_Text">rtn</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
                    
            <span class="ActionScriptComment">// if (rtn) _LOG.debug(n1.stringid + &quot;, &quot; + n2.stringid + &quot; are directly connected&quot;);
</span>            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">rtn</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/*********************************************
        * Mouse Event Handling Methods
        * ********************************************/</span>
        <span class="ActionScriptASDoc">/**
         * @inheritDoc
         */</span>
        <span class="ActionScriptReserved">override</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">dropEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">MouseEvent</span>, <span class="ActionScriptDefault_Text">vn</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IVisualNode</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">/* Activated in three cases:
             * 1: Node Drag/Drop: No action - disabled in VisualGraph
             * 2: Node Clicked: Move the node at the center
             * 3: Node Double-clicked: After changing visibility, move the node at the center
             */</span>
            <span class="ActionScriptComment">// LogUtil.debug(_LOG, &quot;Node: &quot; + vn.node.stringid + &quot; is CENTERED&quot;);
</span>            <span class="ActionScriptDefault_Text">_animationIsometries</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_projector</span>.<span class="ActionScriptDefault_Text">center</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">vn</span>.<span class="ActionScriptDefault_Text">x</span>, <span class="ActionScriptDefault_Text">vn</span>.<span class="ActionScriptDefault_Text">y</span><span class="ActionScriptBracket/Brace">)</span>, <span class="ActionScriptDefault_Text">_vgraph</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">DisplayObject</span>, <span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptDefault_Text">_animInProgress</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">true</span>;
            <span class="ActionScriptDefault_Text">resetAnimation</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptDefault_Text">startAnimation</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * @inheritDoc
         */</span>
        <span class="ActionScriptReserved">override</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">bgDragEvent</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">MouseEvent</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">//LogUtil.debug(_LOG, &quot;Canvas started DRAG&quot;);
</span>            <span class="ActionScriptDefault_Text">_dragStartX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">localX</span>;
            <span class="ActionScriptDefault_Text">_dragStartY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">localY</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * @inheritDoc
         */</span>
        <span class="ActionScriptReserved">override</span> <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">bgDragContinue</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">MouseEvent</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">//LogUtil.debug(_LOG, &quot;Canvas being DRAGGED...&quot;);
</span>            
            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">startPt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Point</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_dragStartX</span>, <span class="ActionScriptDefault_Text">_dragStartY</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptComment">// get start point of dragging but do not adjust node if it is out of bounds
</span>            <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">startIPt</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IPoint</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_projector</span>.<span class="ActionScriptDefault_Text">unProject</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">startPt</span>, <span class="ActionScriptDefault_Text">_vgraph</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">DisplayObject</span>, <span class="ActionScriptReserved">false</span><span class="ActionScriptBracket/Brace">)</span>;
            
            <span class="ActionScriptComment">/* Restrict dragging to smaller steps. 
             * Distances in Hyperbolic geometry are very high close to the edge of the unit circle
             */</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">startIPt</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptOperator">&amp;&amp;</span> <span class="ActionScriptBracket/Brace">((</span><span class="ActionScriptDefault_Text">startIPt</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">ComplexNumber</span><span class="ActionScriptBracket/Brace">)</span>.<span class="ActionScriptDefault_Text">norm</span><span class="ActionScriptBracket/Brace">()</span> <span class="ActionScriptOperator">&lt;</span> 0.9<span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">// get isometry for changing the viewMatrix
</span>                <span class="ActionScriptvar">var</span> <span class="ActionScriptDefault_Text">isometries</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">Array</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">_projector</span>.<span class="ActionScriptDefault_Text">moveP</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">startIPt</span>, <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Point</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">localX</span> , <span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">localY</span><span class="ActionScriptBracket/Brace">)</span>,
                                                                                                <span class="ActionScriptDefault_Text">_vgraph</span> <span class="ActionScriptReserved">as</span> <span class="ActionScriptDefault_Text">DisplayObject</span>, <span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">isometries</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                    <span class="ActionScriptDefault_Text">_projector</span>.<span class="ActionScriptDefault_Text">setViewMatrix</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">isometries</span><span class="ActionScriptBracket/Brace">[</span>0<span class="ActionScriptBracket/Brace">])</span>;
                    <span class="ActionScriptComment">// Refresh Node positions - project and update
</span>                    <span class="ActionScriptDefault_Text">projectNodes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;
                    <span class="ActionScriptDefault_Text">_vgraph</span>.<span class="ActionScriptDefault_Text">refresh</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptComment">// update dragging start point
</span>            <span class="ActionScriptDefault_Text">_dragStartX</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">localX</span>;
            <span class="ActionScriptDefault_Text">_dragStartY</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptDefault_Text">event</span>.<span class="ActionScriptDefault_Text">localY</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
  <span class="ActionScriptASDoc">/************************************************
     * Helper Methods - Node Animation, Misc.
     ************************************************/</span>
        <span class="ActionScriptASDoc">/**
         * @inheritDoc
         */</span>
        <span class="ActionScriptReserved">public</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptReserved">get</span> <span class="ActionScriptDefault_Text">projector</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">IProjector</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">return</span> <span class="ActionScriptDefault_Text">_projector</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * This method kills any currently running timers
         * */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">killTimer</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_animTimer</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">_animTimer</span>.<span class="ActionScriptDefault_Text">stop</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptDefault_Text">_animTimer</span>.<span class="ActionScriptDefault_Text">reset</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>

        <span class="ActionScriptASDoc">/**
         * Reset/Reinitialise animation related variables.
         * */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">resetAnimation</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">/* reset animation cycle */</span>
            <span class="ActionScriptDefault_Text">_animStep</span> <span class="ActionScriptOperator">=</span> 0;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * Performs one animation step.
         * */</span>
        <span class="ActionScriptReserved">protected</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">animate</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">// Check for end condition
</span>            <span class="ActionScriptReserved">if</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_animStep</span> <span class="ActionScriptOperator">&gt;=</span> <span class="ActionScriptDefault_Text">ANIMATION_STEPS</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptComment">//LogUtil.warn(_LOG, &quot;Animation complete, dragged/clicked node is in its final position&quot;);
</span>                <span class="ActionScriptComment">//applyTargetToNodes(_vgraph.visibleVNodes);
</span>                <span class="ActionScriptDefault_Text">_animInProgress</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">false</span>;
                <span class="ActionScriptDefault_Text">_animationIsometries</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> 
              <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_animationIsometries</span> <span class="ActionScriptOperator">!=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span><span class="ActionScriptComment">// Perform animation step
</span>                <span class="ActionScriptDefault_Text">_projector</span>.<span class="ActionScriptDefault_Text">setViewMatrix</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_animationIsometries</span><span class="ActionScriptBracket/Brace">[</span><span class="ActionScriptDefault_Text">_animStep</span><span class="ActionScriptBracket/Brace">])</span>;
                <span class="ActionScriptComment">// Refresh Node positions - project and update
</span>                <span class="ActionScriptDefault_Text">projectNodes</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptReserved">true</span><span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">_vgraph</span>.<span class="ActionScriptDefault_Text">refresh</span><span class="ActionScriptBracket/Brace">()</span>;
                <span class="ActionScriptOperator">++</span><span class="ActionScriptDefault_Text">_animStep</span>;
                <span class="ActionScriptDefault_Text">startAnimation</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptBracket/Brace">}</span>
        <span class="ActionScriptASDoc">/**
         * @internal
         * This starts the animation to perform successive transformations to the view matrix
         * Used move the selected node to the center
         * */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">startAnimation</span><span class="ActionScriptBracket/Brace">()</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptReserved">if</span> <span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">_animTimer</span> <span class="ActionScriptOperator">==</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">_animTimer</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">new</span> <span class="ActionScriptDefault_Text">Timer</span><span class="ActionScriptBracket/Brace">(</span>50, 1<span class="ActionScriptBracket/Brace">)</span>;
                <span class="ActionScriptDefault_Text">_animTimer</span>.<span class="ActionScriptDefault_Text">addEventListener</span><span class="ActionScriptBracket/Brace">(T</span><span class="ActionScriptDefault_Text">imerEvent</span>.<span class="ActionScriptDefault_Text">TIMER_COMPLETE</span>, <span class="ActionScriptDefault_Text">animTimerFired</span><span class="ActionScriptBracket/Brace">)</span>;
            <span class="ActionScriptBracket/Brace">}</span> <span class="ActionScriptReserved">else</span> <span class="ActionScriptBracket/Brace">{</span>
                <span class="ActionScriptDefault_Text">killTimer</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptBracket/Brace">}</span>
            <span class="ActionScriptDefault_Text">_animTimer</span>.<span class="ActionScriptDefault_Text">start</span><span class="ActionScriptBracket/Brace">()</span>;
        <span class="ActionScriptBracket/Brace">}</span>
        
        <span class="ActionScriptASDoc">/**
         * @internal
         * Event handler when the timer fired, just calls the animate 
         * function to do one step of view matrix translation
         * 
         * @param event The fired timer event, will be ignored anyway.
         * */</span>
        <span class="ActionScriptReserved">private</span> <span class="ActionScriptfunction">function</span> <span class="ActionScriptDefault_Text">animTimerFired</span><span class="ActionScriptBracket/Brace">(</span><span class="ActionScriptDefault_Text">event</span><span class="ActionScriptOperator">:</span><span class="ActionScriptDefault_Text">TimerEvent</span> <span class="ActionScriptOperator">=</span> <span class="ActionScriptReserved">null</span><span class="ActionScriptBracket/Brace">)</span><span class="ActionScriptOperator">:</span><span class="ActionScriptReserved">void</span> <span class="ActionScriptBracket/Brace">{</span>
            <span class="ActionScriptComment">//LogUtil.warn(_LOG, &quot;Timer fired!&quot;);
</span>            <span class="ActionScriptDefault_Text">animate</span><span class="ActionScriptBracket/Brace">()</span>;
            <span class="ActionScriptComment">//event.updateAfterEvent();
</span>        <span class="ActionScriptBracket/Brace">}</span>
    <span class="ActionScriptBracket/Brace">}</span>
<span class="ActionScriptBracket/Brace">}</span>
</pre></body>
</html>
